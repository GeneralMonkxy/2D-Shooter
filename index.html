<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Shooter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --dark-bg: #1a1a1a;
            --medium-bg: #2c2c2c;
            --light-bg: #3d3d3d;
            --text-color: #f0f0f0;
            --accent-color: #00aaff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .screen.active {
            display: flex;
        }

        /* Main Menu Styling */
        #main-menu {
            background-color: var(--dark-bg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'%3E%3Cg fill='%232a2a2a' fill-opacity='0.4'%3E%3Cpath d='M86.3 39.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM61.3 22.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM61.3 56.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM86.3 73.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM36.3 56.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM11.3 73.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM36.3 22.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5zM11.3 39.5c-2.8-2-3.5-5.8-1.5-8.5 2-2.8 5.8-3.5 8.5-1.5 2.8 2 3.5 5.8 1.5 8.5-2 2.8-5.7 3.5-8.5 1.5z'/%3E%3C/g%3E%3C/svg%3E");
            gap: 0; /* No direct gap on main container */
        }

        .main-menu-content {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: clamp(15px, 3vh, 25px);
        }

        h1 {
            font-size: clamp(3rem, 10vw, 4.5rem);
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
            text-shadow: 0 0 15px var(--accent-color);
            text-align: center;
        }

        .menu-button {
            background-color: var(--medium-bg);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
            padding: clamp(12px, 2vh, 15px) clamp(25px, 5vw, 40px);
            font-size: clamp(1.1rem, 4vw, 1.5rem);
            border-radius: 10px;
            cursor: pointer;
            width: clamp(260px, 60vw, 320px);
            text-align: center;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .menu-button:hover {
            background-color: var(--accent-color);
            color: var(--dark-bg);
            box-shadow: 0 0 20px var(--accent-color);
        }

        .footer-area {
            margin-top: auto; /* Pushes this element to the bottom */
            padding-bottom: clamp(15px, 4vh, 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .footer-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-button {
            background: none;
            border: 2px solid #777;
            color: white;
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            cursor: pointer;
            width: clamp(40px, 9vw, 50px);
            height: clamp(40px, 9vw, 50px);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }
        .icon-button:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .creator-credit {
            font-size: clamp(0.8rem, 2vw, 1rem);
            color: var(--accent-color);
            font-weight: bold;
            margin: 0;
        }
        
        /* Customization Screen Styling */
        #customization-screen { 
            gap: clamp(15px, 3vh, 20px); 
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: clamp(20px, 5vh, 40px);
            padding-bottom: clamp(20px, 5vh, 40px);
        }
        .customization-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            width: 100%; 
            max-width: 800px; 
            justify-content: center; 
        }
        .player-panel { 
            background-color: var(--medium-bg); 
            padding: clamp(15px, 3vw, 20px); 
            border-radius: 15px; 
            width: clamp(280px, 80vw, 350px);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex-shrink: 0;
        }
        .player-panel h2 { margin-top: 0; font-size: clamp(1.5rem, 5vw, 2rem); }
        .preview-box { width: clamp(80px, 20vw, 100px); height: clamp(80px, 20vw, 100px); border: 3px solid var(--light-bg); margin: 15px 0; display: flex; justify-content: center; align-items: center; position: relative; }
        .shape-preview { width: 80%; height: 80%; position: relative; }
        .shape-preview[data-shape="triangle"] { width: 0; height: 0; border-left: clamp(32px, 10vw, 40px) solid transparent; border-right: clamp(32px, 10vw, 40px) solid transparent; border-bottom: clamp(56px, 17.5vw, 70px) solid; background-color: transparent !important; }
        .shape-preview[data-shape="square"] { border-radius: 0; }
        .shape-preview[data-shape="circle"] { border-radius: 50%; }
        .weapon-preview { width: 60%; height: 12%; border-radius: 5px; position: absolute; top: 50%; left: 50%; transform: translateY(-50%); }

        .color-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .color-swatch { width: clamp(28px, 8vw, 35px); height: clamp(28px, 8vw, 35px); border-radius: 50%; cursor: pointer; border: 3px solid transparent; }
        .color-swatch.selected { border-color: var(--accent-color); transform: scale(1.1); }
        .selector-label { margin-top: 15px; font-size: clamp(1rem, 4vw, 1.2rem); color: #aaa; margin-bottom: 5px;}

        .shape-selector { display: flex; gap: 10px; margin-top: 10px; }
        .shape-btn { background-color: var(--light-bg); border: 2px solid #555; color: white; width: clamp(32px, 9vw, 40px); height: clamp(32px, 9vw, 40px); border-radius: 8px; font-size: clamp(1.2rem, 5vw, 1.5rem); cursor: pointer;}
        .shape-btn.selected { border-color: var(--accent-color); background-color: var(--medium-bg); }

        /* Game Screen Styling */
        #game-screen { background-color: #000; padding: 0; }
        canvas { background-color: var(--medium-bg); display: block; max-width: 100vw; max-height: 100vh; object-fit: contain; border: 2px solid var(--accent-color); }
        #game-ui { box-sizing: border-box; position: absolute; top: 0; left: 0; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: clamp(5px, 1.5vh, 10px) clamp(10px, 3vw, 20px); background-color: rgba(0, 0, 0, 0.6); }
        .ui-section { display: flex; align-items: center; gap: clamp(8px, 2vw, 15px); }
        #player1-score, #player2-score, #game-timer, #round-counter { font-size: clamp(1.2rem, 4vw, 2rem); font-weight: bold; }
        .game-ui-btn { background: none; border: 2px solid #777; color: white; font-size: clamp(1rem, 3.5vw, 1.5rem); cursor: pointer; width: clamp(32px, 8vw, 40px); height: clamp(32px, 8vw, 40px); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .game-ui-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .game-ui-btn svg { width: 60%; height: 60%; stroke: white; }

        /* Modal Styling */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--medium-bg); padding: clamp(20px, 5vw, 40px); border-radius: 15px; width: 90%; max-width: 600px; border: 2px solid var(--accent-color); font-size: clamp(0.9rem, 3vw, 1.1rem); }
        .modal-content ul { padding-left: 20px; text-align: left; }
        .modal-content li { margin-bottom: 10px; }
        #winner-text { font-size: clamp(2rem, 8vw, 3rem); font-weight: bold; text-align: center; }
        .stats-container { padding: clamp(15px, 4vw, 20px) clamp(20px, 6vw, 40px); }
        .end-game-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center; }
        
    </style>
</head>
<body>

    <div id="main-menu" class="screen">
        <div class="main-menu-content">
            <h1>2D Shooter</h1>
            <button id="vs-cpu-btn" class="menu-button">1P vs CPU</button>
            <button id="two-players-btn" class="menu-button">2 Players</button>
        </div>
        <div class="footer-area">
            <div class="footer-controls">
                <button id="how-to-play-btn-main" class="icon-button">?</button>
                <button id="settings-btn-main" class="icon-button">⚙️</button>
            </div>
            <p class="creator-credit">@GMonkxy Games</p>
        </div>
    </div>

    <div id="customization-screen" class="screen">
        <div class="customization-container">
            <div class="player-panel">
                <h2>Player 1</h2>
                <div class="preview-box">
                    <div id="p1-shape-preview" class="shape-preview" data-shape="circle"></div>
                    <div id="p1-weapon-preview" class="weapon-preview"></div>
                </div>
                 <p class="selector-label">Shape</p>
                <div class="shape-selector" id="p1-shape-selector">
                    <button class="shape-btn selected" data-shape="circle">●</button>
                    <button class="shape-btn" data-shape="square">■</button>
                    <button class="shape-btn" data-shape="triangle">▲</button>
                </div>
                <p class="selector-label">Player Color</p>
                <div id="p1-body-colors" class="color-selector"></div>
                <p class="selector-label">Weapon Color</p>
                <div id="p1-weapon-colors" class="color-selector weapon-colors"></div>
            </div>
            <div class="player-panel">
                <h2 id="p2-panel-title">Player 2</h2>
                 <div class="preview-box">
                    <div id="p2-shape-preview" class="shape-preview" data-shape="circle"></div>
                    <div id="p2-weapon-preview" class="weapon-preview"></div>
                </div>
                 <p class="selector-label">Shape</p>
                <div class="shape-selector" id="p2-shape-selector">
                    <button class="shape-btn selected" data-shape="circle">●</button>
                    <button class="shape-btn" data-shape="square">■</button>
                    <button class="shape-btn" data-shape="triangle">▲</button>
                </div>
                <p class="selector-label">Player Color</p>
                <div id="p2-body-colors" class="color-selector"></div>
                <p class="selector-label">Weapon Color</p>
                <div id="p2-weapon-colors" class="color-selector weapon-colors"></div>
                <div id="cpu-difficulty-selector" style="display: none; width: 100%; text-align: center; margin-top: 15px;">
                    <p class="selector-label">CPU Difficulty</p>
                    <select id="difficulty-level" class="menu-button" style="width: 90%; font-size: 1.2rem; padding: 10px;">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="insane">Insane</option>
                    </select>
                </div>
            </div>
        </div>
        <div>
            <h2 class="selector-label">Game Mode</h2>
            <select id="game-mode-selector" class="menu-button">
                <option value="120s">120 Seconds</option>
                <option value="5rounds">5 Rounds</option>
                <option value="endless">Endless</option>
            </select>
        </div>
        <button id="start-game-btn" class="menu-button" style="margin-top: 20px;">Start Game</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-ui">
             <div class="ui-section">
                <button id="home-btn" class="game-ui-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                </button>
                <div id="player1-score">P1: 0</div>
            </div>
            <div class="ui-section">
                <div id="game-timer">2:00</div>
                <div id="round-counter" style="display: none;"></div>
                <button id="pause-btn" class="game-ui-btn">▶</button>
            </div>
            <div class="ui-section">
                <div id="player2-score">P2: 0</div>
                <button id="help-btn" class="game-ui-btn">?</button>
                 <button id="settings-btn-game" class="game-ui-btn">⚙️</button>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="end-game-screen" class="screen modal">
        <div class="modal-content"><h2 id="winner-text"></h2><div class="stats-container"><p>Kills: <span id="final-kills"></span></p><p>Deaths: <span id="final-deaths"></span></p><p>Accuracy: <span id="final-accuracy"></span></p></div><div class="end-game-buttons"><button id="play-again-btn" class="menu-button">Play Again</button><button id="main-menu-btn" class="menu-button">Main Menu</button></div></div>
    </div>
    <div id="how-to-play-modal" class="screen modal">
        <div class="modal-content">
            <h2>How to Play</h2>
            <p><strong>P1 Controls:</strong> WASD to move, F/G to shoot.</p>
            <p><strong>P2 Controls:</strong> Arrow Keys to move, K/L to shoot.</p>
            <h3>Power-Ups</h3>
            <p>Grab blue boxes for a temporary advantage!</p>
            <ul>
                <li><strong>⚡ (2x Speed):</strong> Doubles your movement speed for 10 seconds.</li>
                <li><strong>💥 (2x Damage):</strong> Your shots deal 50% damage for 10 seconds.</li>
                <li><strong>🛡️ (Shield):</strong> Blocks the next shot that hits you. A blue bubble will appear around you.</li>
                <li><strong>🔫 (Insta-Kill):</strong> The next shot you fire will instantly defeat your opponent. Use it wisely!</li>
            </ul>
            <button class="modal-close-btn menu-button">Close</button>
        </div>
    </div>
     <div id="settings-modal" class="screen modal">
        <div class="modal-content">
            <h2>Settings</h2>
            <div style="margin: 20px 0;">
                <label for="music-select" class="selector-label">Background Music</label>
                <select id="music-select" class="menu-button" style="width: 100%;">
                    <option value="0">Retro Vibe</option>
                    <option value="1">Ambient Chill</option>
                    <option value="2">Action Pulse</option>
                    <option value="3">Lo-fi Groove</option>
                    <option value="4">Energetic Synth</option>
                    <option value="5">None</option>
                </select>
            </div>
            <button id="mute-btn" class="menu-button" style="width: 100%;">Mute</button>
            <button class="modal-close-btn menu-button" style="margin-top: 20px; background-color: #444;">Close</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Global Variables & Constants ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const shootSynth = new Tone.Synth().toDestination();
    const powerupSynth = new Tone.Synth({ oscillator: { type: 'triangle' } }).toDestination();
    const endGameSynth = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();

    let gameActive = false,
        isGamePaused = true,
        isVsCPU = false,
        gameMode = '120s';
    let players = [],
        projectiles = [],
        obstacles = [],
        powerUps = [];
    let gameTimer = 120,
        suddenDeath = false,
        animationFrameId;

    const PLAYER_COLORS = ['#4CAF50', '#F44336', '#2196F3', '#FFEB3B', '#9C27B0', '#FF9800', '#00BCD4', '#E91E63'];
    const WEAPON_COLORS = ['#FFFFFF', '#795548', '#607D8B', '#FFC107', '#8BC34A', '#CDDC39', '#FF5722', '#03A9F4'];
    const MAP_LAYOUTS = [
        [{ x: 0.2, y: 0.2, w: 0.05, h: 0.2 }, { x: 0.75, y: 0.2, w: 0.05, h: 0.2 }, { x: 0.2, y: 0.6, w: 0.05, h: 0.2 }, { x: 0.75, y: 0.6, w: 0.05, h: 0.2 }, { x: 0.4, y: 0.45, w: 0.2, h: 0.1 }],
        [{ x: 0.35, y: 0.1, w: 0.3, h: 0.05 }, { x: 0.35, y: 0.85, w: 0.3, h: 0.05 }, { x: 0.1, y: 0.4, w: 0.05, h: 0.2 }, { x: 0.85, y: 0.4, w: 0.05, h: 0.2 }, { x: 0.45, y: 0.3, w: 0.1, h: 0.4 }],
        [{ x: 0.1, y: 0.25, w: 0.2, h: 0.05 }, { x: 0.7, y: 0.25, w: 0.2, h: 0.05 }, { x: 0.4, y: 0.1, w: 0.2, h: 0.05 }, { x: 0.4, y: 0.85, w: 0.2, h: 0.05 }, { x: 0.1, y: 0.7, w: 0.2, h: 0.05 }, { x: 0.7, y: 0.7, w: 0.2, h: 0.05 }]
    ];
    const CPU_DIFFICULTY_SETTINGS = {
        easy: { speedMultiplier: 0.7, shootFrequency: 0.015, accuracyError: 0.3 },
        medium: { speedMultiplier: 1.0, shootFrequency: 0.03, accuracyError: 0.15 },
        hard: { speedMultiplier: 1.2, shootFrequency: 0.05, accuracyError: 0.05 },
        insane: { speedMultiplier: 1.4, shootFrequency: 0.08, accuracyError: 0.01 }
    };
    
    // --- Music Synthesis ---
    let musicTracks = [];
    let currentTrack = null;
    function setupMusic() {
        const musicSynth = new Tone.Synth({ oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 } }).toDestination();
        musicTracks = [
            new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "8n", time); }, ["C4", "E4", "G4", "B4"], "4n"),
            new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "2n", time); }, ["C3", ["E3", "G3"], "A3", ["G3", "C4"]], "1m"),
            new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "16n", time); }, ["C2", "C3", "C2", "G2"], "8n"),
            new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "4n", time); }, [["A#2", "D3", "F3"], null, ["G2", "C3", "D#3"], null], "2n"),
            new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "16n", time); }, ["C5", "D5", "E5", "G5", "A5", "G5", "E5", "D5"], "8n")
        ];
        musicTracks.forEach(track => track.loop = true);
    }
    
    function playMusic(index) {
        if (currentTrack) currentTrack.stop();
        if (index >= 0 && index < musicTracks.length) {
            currentTrack = musicTracks[index];
            if (Tone.Transport.state !== 'started') Tone.Transport.start();
            currentTrack.start(0);
        }
    }


    // --- Screen & Modal Management ---
    const screens = document.querySelectorAll('.screen');
    function showScreen(id) { screens.forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }

    // --- Event Listeners ---
    document.getElementById('vs-cpu-btn').addEventListener('click', () => { isVsCPU = true; setupCustomizationScreen(); showScreen('customization-screen'); });
    document.getElementById('two-players-btn').addEventListener('click', () => { isVsCPU = false; setupCustomizationScreen(); showScreen('customization-screen'); });
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('play-again-btn').addEventListener('click', startGame);
    document.getElementById('main-menu-btn').addEventListener('click', () => { if (animationFrameId) cancelAnimationFrame(animationFrameId); gameActive = false; hideModal('end-game-screen'); showScreen('main-menu'); });
    document.getElementById('pause-btn').addEventListener('click', () => { isGamePaused = !isGamePaused; document.getElementById('pause-btn').textContent = isGamePaused ? '▶' : '❚❚'; document.getElementById('home-btn').disabled = document.getElementById('help-btn').disabled = document.getElementById('settings-btn-game').disabled = !isGamePaused; });
    document.getElementById('home-btn').addEventListener('click', () => { if (isGamePaused) { gameActive = false; cancelAnimationFrame(animationFrameId); showScreen('main-menu'); } });
    document.getElementById('help-btn').addEventListener('click', () => { isGamePaused = true; document.getElementById('pause-btn').textContent = '▶'; document.getElementById('home-btn').disabled = false; document.getElementById('settings-btn-game').disabled = false; showModal('how-to-play-modal'); });
    document.getElementById('how-to-play-btn-main').addEventListener('click', () => showModal('how-to-play-modal'));
    document.getElementById('settings-btn-main').addEventListener('click', () => showModal('settings-modal'));
    document.getElementById('settings-btn-game').addEventListener('click', () => { isGamePaused = true; document.getElementById('pause-btn').textContent = '▶'; showModal('settings-modal'); });
    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => { hideModal('how-to-play-modal'); hideModal('settings-modal'); }));
    document.getElementById('mute-btn').addEventListener('click', () => {
        Tone.Destination.mute = !Tone.Destination.mute;
        document.getElementById('mute-btn').textContent = Tone.Destination.mute ? "Unmute" : "Mute";
    });
    document.getElementById('music-select').addEventListener('change', (e) => {
        playMusic(parseInt(e.target.value));
    });
    window.addEventListener('resize', resizeGame);

    // --- Customization UI ---
    function createSwatches(container, items, clickHandler, type) {
        container.innerHTML = '';
        items.forEach((item, i) => {
            const el = document.createElement(type === 'color' ? 'div' : 'button');
            el.className = type === 'color' ? 'color-swatch' : 'shape-btn';
            if (type === 'color') {
                el.style.backgroundColor = item;
                el.dataset.color = item;
            } else {
                el.textContent = { circle: '●', square: '■', triangle: '▲' }[item];
                el.dataset.shape = item;
            }
            if (i === 0) el.classList.add('selected');
            el.addEventListener('click', () => clickHandler(el, container));
            container.appendChild(el);
        });
    }

    function handleSelection(el, container) {
        container.querySelectorAll(`.${el.className}`).forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        updatePreviews();
    }

    function setupCustomizationScreen() {
        ['p1', 'p2'].forEach(p => {
            createSwatches(document.getElementById(`${p}-shape-selector`), ['circle', 'square', 'triangle'], handleSelection, 'shape');
            createSwatches(document.getElementById(`${p}-body-colors`), PLAYER_COLORS, handleSelection, 'color');
            createSwatches(document.getElementById(`${p}-weapon-colors`), WEAPON_COLORS, handleSelection, 'color');
        });
        document.getElementById('p2-panel-title').textContent = isVsCPU ? 'CPU' : 'Player 2';
        document.getElementById('p2-shape-selector').style.pointerEvents = isVsCPU ? 'none' : 'auto';
        document.getElementById('p2-body-colors').style.pointerEvents = isVsCPU ? 'none' : 'auto';
        document.getElementById('p2-weapon-colors').style.pointerEvents = isVsCPU ? 'none' : 'auto';

        document.getElementById('cpu-difficulty-selector').style.display = isVsCPU ? 'block' : 'none';

        if (isVsCPU) {
            document.querySelector('#p2-shape-selector').children[Math.floor(Math.random() * 3)].click();
            document.querySelector('#p2-body-colors').children[Math.floor(Math.random() * PLAYER_COLORS.length)].click();
            document.querySelector('#p2-weapon-colors').children[Math.floor(Math.random() * WEAPON_COLORS.length)].click();
        }
        updatePreviews();
    }

    function updatePreviews() {
        ['p1', 'p2'].forEach(p => {
            const shape = document.querySelector(`#${p}-shape-selector .selected`).dataset.shape;
            const bodyColor = document.querySelector(`#${p}-body-colors .selected`).dataset.color;
            const weaponColor = document.querySelector(`#${p}-weapon-colors .selected`).dataset.color;
            const shapePreview = document.getElementById(`${p}-shape-preview`);
            shapePreview.dataset.shape = shape;
            shapePreview.style.backgroundColor = shape === 'triangle' ? 'transparent' : bodyColor;
            shapePreview.style.borderBottomColor = bodyColor;
            document.getElementById(`${p}-weapon-preview`).style.backgroundColor = weaponColor;
        });
    }

    // --- Game Setup ---
    async function startGame() {
        await Tone.start();
        hideModal('end-game-screen');
        gameMode = document.getElementById('game-mode-selector').value;
        const p1Shape = document.querySelector('#p1-shape-selector .selected').dataset.shape;
        const p1Body = document.querySelector('#p1-body-colors .selected').dataset.color;
        const p1Weapon = document.querySelector('#p1-weapon-colors .selected').dataset.color;
        const p2Shape = document.querySelector('#p2-shape-selector .selected').dataset.shape;
        const p2Body = document.querySelector('#p2-body-colors .selected').dataset.color;
        const p2Weapon = document.querySelector('#p2-weapon-colors .selected').dataset.color;

        players = [new Player(p1Body, p1Weapon, 1, p1Shape), new Player(p2Body, p2Weapon, 2, p2Shape)];

        if (isVsCPU) {
            players[1].isCPU = true;
            players[1].difficulty = document.getElementById('difficulty-level').value;
        }

        players.forEach(p => p.resetStats());
        projectiles = [];
        powerUps = [];
        suddenDeath = false;
        
        resizeGame();
        resetGameTimer();
        updateScoreboard();

        isGamePaused = true;
        document.getElementById('pause-btn').textContent = '▶';
        document.getElementById('home-btn').disabled = false;
        document.getElementById('help-btn').disabled = false;
        document.getElementById('settings-btn-game').disabled = false;

        gameActive = true;
        showScreen('game-screen');
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();
    }

    function resizeGame() {
        const aspect = 16 / 9;
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        
        let canvasWidth = screenWidth;
        let canvasHeight = screenWidth / aspect;
        
        if (canvasHeight > screenHeight) {
            canvasHeight = screenHeight;
            canvasWidth = screenHeight * aspect;
        }

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        if (players.length > 0) {
            players.forEach(p => p.updateSizeAndPosition());
        }
        generateMap(MAP_LAYOUTS[Math.floor(Math.random() * MAP_LAYOUTS.length)]);
    }

    function resetGameTimer() {
        const roundEl = document.getElementById('round-counter');
        const timerEl = document.getElementById('game-timer');
        if (gameMode === '120s') {
            gameTimer = 120;
            timerEl.textContent = "2:00";
            timerEl.style.display = 'block';
            roundEl.style.display = 'none';
        } else if (gameMode === 'endless') {
            gameTimer = -1;
            timerEl.style.display = 'none';
            roundEl.style.display = 'block';
            roundEl.innerHTML = '&#8734;';
        } else {
            gameTimer = -1;
            timerEl.style.display = 'none';
            roundEl.style.display = 'block';
            roundEl.textContent = `First to 5`;
        }
    }

    function generateMap(layout) {
        obstacles = layout.map(o => ({
            x: o.x * canvas.width,
            y: o.y * canvas.height,
            w: o.w * canvas.width,
            h: o.h * canvas.height
        }));
    }

    // --- Classes ---
    class Player {
        constructor(c, wC, pN, shape) {
            this.color = c;
            this.weaponColor = wC;
            this.playerNumber = pN;
            this.shape = shape;
            this.keys = {};
        }

        resetStats() {
            this.hp = 100;
            this.score = 0;
            this.shootCooldown = 0;
            this.invincible = false;
            this.invincibleTimer = 0;
            this.powerUp = null;
            this.powerUpTimer = 0;
            this.shotsFired = 0;
            this.shotsHit = 0;
            this.deaths = 0;
            this.cpuState = 'seeking';
            this.cpuStateTimer = 0;
        }

        updateSizeAndPosition() {
            const size = canvas.width * 0.03;
            this.radius = size;
            this.x = this.playerNumber === 1 ? size * 2 : canvas.width - size * 2;
            this.y = this.playerNumber === 1 ? size * 2 : canvas.height - size * 2;
            this.spawnX = this.x;
            this.spawnY = this.y;
            this.speed = canvas.width * 0.0025;
            if (this.isCPU && this.difficulty) {
                const settings = CPU_DIFFICULTY_SETTINGS[this.difficulty];
                this.speed *= settings.speedMultiplier;
                this.shootFrequency = settings.shootFrequency;
                this.accuracyError = settings.accuracyError;
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            // Draw Spawn Pad
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            const spawnSize = this.radius * 1.2;
            if (this.shape === 'circle') {
                ctx.arc(this.spawnX, this.spawnY, spawnSize, 0, 2 * Math.PI);
            } else if (this.shape === 'square') {
                ctx.rect(this.spawnX - spawnSize, this.spawnY - spawnSize, spawnSize * 2, spawnSize * 2);
            } else if (this.shape === 'triangle') {
                const h = spawnSize * 1.732;
                ctx.moveTo(this.spawnX, this.spawnY - h / 2);
                ctx.lineTo(this.spawnX - spawnSize, this.spawnY + h / 2);
                ctx.lineTo(this.spawnX + spawnSize, this.spawnY + h / 2);
                ctx.closePath();
            }
            ctx.fill();

            // Draw Player
            ctx.globalAlpha = this.invincible ? 0.5 : 1;
            ctx.beginPath();
            if (this.shape === 'circle') {
                ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
            } else if (this.shape === 'square') {
                ctx.rect(this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
            } else if (this.shape === 'triangle') {
                const h = this.radius * 1.732;
                ctx.moveTo(this.x, this.y - h / 2);
                ctx.lineTo(this.x - this.radius, this.y + h / 2);
                ctx.lineTo(this.x + this.radius, this.y + h / 2);
                ctx.closePath();
            }
            ctx.fill();

            // Draw Weapon and Health
            ctx.globalAlpha = 1;
            const angle = this.isCPU && players[0] ? Math.atan2(players[0].y - this.y, players[0].x - this.x) : this.getAngle();
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(angle);
            ctx.fillStyle = this.weaponColor;
            ctx.fillRect(0, -this.radius * 0.2, this.radius * 1.5, this.radius * 0.4);
            ctx.restore();
            if (this.hp < 100) {
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x - this.radius, this.y - this.radius - 15, this.radius * 2, 5);
                ctx.fillStyle = 'green';
                ctx.fillRect(this.x - this.radius, this.y - this.radius - 15, this.radius * 2 * (this.hp / 100), 5);
            }
            if (this.powerUp === 'shield') {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 1.3, 0, 2 * Math.PI);
                ctx.strokeStyle = '#00aaff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
        }

        getAngle() {
            if (this.playerNumber === 1) {
                if (this.keys['d']) return 0;
                if (this.keys['a']) return Math.PI;
                if (this.keys['w']) return -Math.PI / 2;
                if (this.keys['s']) return Math.PI / 2;
            } else {
                if (this.keys['ArrowRight']) return 0;
                if (this.keys['ArrowLeft']) return Math.PI;
                if (this.keys['ArrowUp']) return -Math.PI / 2;
                if (this.keys['ArrowDown']) return Math.PI / 2;
            }
            return 0;
        }

        update() {
            if (this.isCPU) {
                this.cpuLogic();
            } else {
                this.handleInput();
            }
            if (this.shootCooldown > 0) this.shootCooldown--;
            if (this.invincibleTimer-- <= 0) this.invincible = false;
            if (this.powerUpTimer-- <= 0 && this.powerUp && this.powerUp !== 'shield') this.deactivatePowerUp();
            this.x = Math.max(this.radius, Math.min(this.x, canvas.width - this.radius));
            this.y = Math.max(this.radius, Math.min(this.y, canvas.height - this.radius));
        }

        handleInput() {
            let s = this.speed * (this.powerUp === 'speed' ? 2 : 1),
                dx = 0,
                dy = 0;
            if (this.playerNumber === 1) {
                if (this.keys['w']) dy--;
                if (this.keys['s']) dy++;
                if (this.keys['a']) dx--;
                if (this.keys['d']) dx++;
                if (this.keys['f'] || this.keys['g']) this.shoot();
            } else if (!this.isCPU) {
                if (this.keys['ArrowUp']) dy--;
                if (this.keys['ArrowDown']) dy++;
                if (this.keys['ArrowLeft']) dx--;
                if (this.keys['ArrowRight']) dx++;
                if (this.keys['k'] || this.keys['l']) this.shoot();
            }
            if (dx || dy) {
                const m = Math.sqrt(dx * dx + dy * dy);
                this.x += dx / m * s;
                this.collide(dx / m * s, 0);
                this.y += dy / m * s;
                this.collide(0, dy / m * s);
            }
        }

        cpuLogic() {
            const opp = players[0];
            if (!opp) return;
            if (this.cpuStateTimer-- <= 0) {
                this.cpuState = Math.random() < 0.6 ? 'attacking' : 'seeking';
                this.cpuStateTimer = 150;
            }
            const targetX = this.cpuState === 'attacking' ? opp.x : Math.random() * canvas.width;
            const targetY = this.cpuState === 'attacking' ? opp.y : Math.random() * canvas.height;
            const angle = Math.atan2(targetY - this.y, targetX - this.x),
                s = this.speed;
            this.x += Math.cos(angle) * s;
            this.collide(Math.cos(angle) * s, 0);
            this.y += Math.sin(angle) * s;
            this.collide(0, Math.sin(angle) * s);
            if (Math.hypot(this.x - opp.x, this.y - opp.y) < canvas.width * 0.7 && Math.random() < this.shootFrequency) {
                this.shoot();
            }
        }

        collide(vx, vy) {
            obstacles.forEach(o => {
                if (this.x - this.radius < o.x + o.w && this.x + this.radius > o.x && this.y - this.radius < o.y + o.h && this.y + this.radius > o.y) {
                    if (vx > 0) this.x = o.x - this.radius;
                    else if (vx < 0) this.x = o.x + o.w + this.radius;
                    if (vy > 0) this.y = o.y - this.radius;
                    else if (vy < 0) this.y = o.y + o.h + this.radius;
                }
            });
        }

        shoot() {
            if (this.shootCooldown > 0) return;
            shootSynth.triggerAttackRelease("C4", "8n");
            this.shotsFired++;
            this.shootCooldown = 30;
            let a = this.getAngle();
            if (this.isCPU && players[0]) {
                const angleToOpponent = Math.atan2(players[0].y - this.y, players[0].x - this.x);
                const error = (Math.random() - 0.5) * 2 * this.accuracyError;
                a = angleToOpponent + error;
            }
            projectiles.push(new Projectile(this.x, this.y, 5, '#ff4500', { x: Math.cos(a) * 7, y: Math.sin(a) * 7 }, this.playerNumber, this.powerUp));
        }

        takeDamage(amt) {
            if (this.invincible) return;
            if (this.powerUp === 'shield') {
                this.deactivatePowerUp();
                return;
            }
            this.hp -= amt;
            if (this.hp <= 0) {
                this.respawn();
                const o = players.find(p => p.playerNumber !== this.playerNumber);
                o.score++;
                o.shotsHit++;
                updateScoreboard();
                checkWinCondition();
            }
        }

        respawn() {
            this.hp = 100;
            this.x = this.spawnX;
            this.y = this.spawnY;
            this.invincible = true;
            this.invincibleTimer = 60;
            this.deaths++;
            if (this.powerUp) this.deactivatePowerUp();
            if (suddenDeath) players.forEach(p => Object.assign(p, { hp: 100, x: p.spawnX, y: p.spawnY, invincible: true, invincibleTimer: 60 }));
        }

        activatePowerUp(t) {
            powerupSynth.triggerAttackRelease("G5", "16n");
            if (this.powerUp) this.deactivatePowerUp();
            this.powerUp = t;
            if (t !== 'shield') this.powerUpTimer = 600;
        }

        deactivatePowerUp() {
            this.powerUp = null;
            this.powerUpTimer = 0;
        }
    }

    class Projectile {
        constructor(x, y, r, c, v, o, p) {
            Object.assign(this, { x, y, radius: r, color: c, velocity: v, owner: o });
            this.damage = p === 'damage' ? 50 : (p === 'instakill' ? 999 : 25);
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
            ctx.fill();
        }
        update() {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
        }
    }

    class PowerUp {
        constructor(x, y, t) {
            this.x = x;
            this.y = y;
            this.type = t;
            this.size = canvas.width * 0.03;
            this.spawnTime = Date.now();
            this.icon = { speed: '⚡', damage: '💥', shield: '🛡️', instakill: '🔫' }[t];
        }
        draw() {
            ctx.fillStyle = '#00aaff';
            ctx.fillRect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
            ctx.font = `${this.size * 0.7}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(this.icon, this.x, this.y);
        }
    }

    // --- Game Logic & Loop ---
    function updateScoreboard() {
        if (!players[0]) return;
        document.getElementById('player1-score').textContent = `P1: ${players[0].score}`;
        document.getElementById('player1-score').style.color = players[0].color;
        document.getElementById('player2-score').textContent = `${isVsCPU ? 'CPU' : 'P2'}: ${players[1].score}`;
        document.getElementById('player2-score').style.color = players[1].color;
    }

    function handleCollisions() {
        for (let i = projectiles.length - 1; i >= 0; i--) {
            const p = projectiles[i];
            let hit = false;
            for (const pl of players) {
                if (pl.playerNumber !== p.owner && Math.hypot(p.x - pl.x, p.y - pl.y) < p.radius + pl.radius) {
                    pl.takeDamage(p.damage);
                    hit = true;
                    break;
                }
            }
            if (!hit)
                for (const o of obstacles) {
                    if (p.x > o.x && p.x < o.x + o.w && p.y > o.y && p.y < o.y + o.h) {
                        hit = true;
                        break;
                    }
                }
            if (hit || p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) projectiles.splice(i, 1);
        }
        for (let i = powerUps.length - 1; i >= 0; i--) {
            for (const pl of players) {
                if (Math.hypot(powerUps[i].x - pl.x, powerUps[i].y - pl.y) < powerUps[i].size / 2 + pl.radius) {
                    pl.activatePowerUp(powerUps[i].type);
                    powerUps.splice(i, 1);
                    break;
                }
            }
        }
    }

    let lastTime = 0,
        timerInterval = 0;

    function gameLoop(t) {
        if (!gameActive) return;
        const dt = t - (lastTime || t);
        lastTime = t;
        if (!isGamePaused) {
            if (gameMode === '120s' && !suddenDeath) {
                timerInterval += dt;
                if (timerInterval >= 1000) {
                    gameTimer--;
                    timerInterval = 0;
                    const m = Math.floor(gameTimer / 60),
                        s = gameTimer % 60;
                    document.getElementById('game-timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
                    if (gameTimer <= 0) checkWinCondition();
                }
            }
            players.forEach(p => p.update());
            projectiles.forEach(p => p.update());
            handleCollisions();
            managePowerUps();
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        obstacles.forEach(o => { ctx.fillStyle = '#666'; ctx.fillRect(o.x, o.y, o.w, o.h); });
        powerUps.forEach(p => p.draw());
        players.forEach(p => p.draw());
        projectiles.forEach(p => p.draw());
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    let instaKillSpawned = false;

    function managePowerUps() {
        powerUps = powerUps.filter(p => Date.now() - p.spawnTime < 20000);
        if (powerUps.length < 2 && Math.random() < 0.01) {
            const x = Math.random() * canvas.width * 0.8 + 0.1 * canvas.width,
                y = Math.random() * canvas.height * 0.8 + 0.1 * canvas.height;
            let t;
            const r = Math.random();
            if (r < 0.4) t = 'speed';
            else if (r < 0.7) t = 'damage';
            else if (r < 0.95) t = 'shield';
            else if (!instaKillSpawned) {
                t = 'instakill';
                instaKillSpawned = true;
            }
            if (t) powerUps.push(new PowerUp(x, y, t));
        }
    }

    function checkWinCondition() {
        let w = null;
        if (suddenDeath) {
            if (players[0].score > players[1].score) w = players[0];
            if (players[1].score > players[0].score) w = players[1];
        } else if (gameMode === '120s' && gameTimer <= 0) {
            if (players[0].score > players[1].score) w = players[0];
            else if (players[1].score > players[0].score) w = players[1];
            else {
                suddenDeath = true;
                document.getElementById('game-timer').textContent = "SUDDEN DEATH";
                players.forEach(p => p.respawn());
            }
        } else if (gameMode === '5rounds') {
            if (players[0].score >= 5) w = players[0];
            if (players[1].score >= 5) w = players[1];
        }
        if (w) endGame(w);
    }

    function endGame(w) {
        gameActive = false;
        endGameSynth.triggerAttackRelease("C3", "4n");
        document.getElementById('winner-text').textContent = `Winner: ${isVsCPU && w.playerNumber === 2 ? 'CPU' : `Player ${w.playerNumber}`}`;
        document.getElementById('winner-text').style.color = w.color;
        document.getElementById('final-kills').textContent = w.score;
        document.getElementById('final-deaths').textContent = w.deaths;
        document.getElementById('final-accuracy').textContent = `${w.shotsFired > 0 ? Math.round((w.shotsHit / w.shotsFired) * 100) : 0}%`;
        showModal('end-game-screen');
    }

    // --- Keyboard Input ---
    window.addEventListener('keydown', e => {
        if (!players[0]) return;
        players.forEach(p => {
            if (p.playerNumber === 1 && 'wasdfg'.includes(e.key.toLowerCase())) p.keys[e.key.toLowerCase()] = true;
            if (p.playerNumber === 2 && !p.isCPU && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'k', 'l'].includes(e.key)) p.keys[e.key] = true;
        });
    });
    window.addEventListener('keyup', e => {
        if (!players[0]) return;
        players.forEach(p => {
            if (p.playerNumber === 1 && 'wasdfg'.includes(e.key.toLowerCase())) p.keys[e.key.toLowerCase()] = false;
            if (p.playerNumber === 2 && !p.isCPU && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'k', 'l'].includes(e.key)) p.keys[e.key] = false;
        });
    });

    // --- Initial Load ---
    setupMusic();
    showScreen('main-menu');
});
</script>
</body>
</html>


